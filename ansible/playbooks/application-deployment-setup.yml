---
- hosts: application

  gather_facts: no
  remote_user: root

  tasks:
    - name: Ensures shared/config dir exists
      file:
        path: "/home/{{ username }}/app_config"
        state: directory
        owner: "{{ username }}"
        group: "{{ username }}"

    - name: Copy prod.secret.exs with owner and permissions
      copy:
        src: ../../config/prod.secret.exs
        dest: "/home/{{ username }}/app_config/prod.secret.exs"
        owner: "{{ username }}"
        group: "{{ username }}"

    - name: Create Systemd Init Script
      template:
        src: "{{ app_name }}.service"
        dest: "/etc/systemd/system/{{ app_name }}.service"

    - name: Enable Systemd service for application
      systemd:
        name: "{{ app_name }}"
        enabled: yes
